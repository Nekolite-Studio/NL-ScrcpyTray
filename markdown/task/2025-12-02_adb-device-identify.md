# ADBデバイス・接続方式識別 実装ガイド

このガイドは、`adb` が出力するバラバラな接続情報を、アプリケーション内部で「物理端末」単位にまとめ上げ、ユーザーに分かりやすく提示するためのロジック定義です。

## 1. データ収集フェーズ（スキャン）

まずは、現在 ADB サーバーが認識しているすべての「接続ハンドル（Connection Handle）」を取得します。

### ステップ 1: 接続リストの取得

すべての接続を取得し、ステータスを確認します。

  * **実行コマンド:**
    ```text
    adb devices -l
    ```
  * **解析対象:**
    出力の **各行の第1列目（空白まで）** が「接続ハンドルID」です。
    また、行の中に `offline` や `unauthorized` が含まれていないかチェックします。
      * `device`: 通信可能（次のステップへ）
      * `unauthorized`: 認証待ち（USBデバッグ許可ダイアログが出ている状態。詳細情報の取得はスキップする）
      * `offline`: 切断または応答なし（詳細情報の取得はスキップする）

### ステップ 2: 固有シリアル（Hardware Serial）の取得

ステータスが `device` であるすべての「接続ハンドルID」に対して、個別に内部情報を問い合わせます。これが名寄せのキー（Key）になります。

  * **実行コマンド:**
    ```text
    adb -s [接続ハンドルID] shell getprop ro.serialno
    ```
  * **期待される出力:**
    デバイス固有のハードウェアシリアル番号（例: `PR6DB6C6YTLFA6T8`）。
    ※ この値は接続方式が変わっても不変です。

-----

## 2. データ統合フェーズ（ロジック）

収集したデータをメモリ上で整理します。

### データ構造のイメージ

アプリケーション内部で、**「ハードウェアシリアル」をキーとした辞書（Map/Dictionary）** を作成し、そこに接続ハンドルを格納していきます。

**処理ロジック:**

1.  取得した `ro.serialno` が、既に辞書にあるか確認する。
2.  **新規の場合:** 新しい「デバイスオブジェクト」を作成し、辞書に登録する。
3.  **既存の場合:** 既存の「デバイスオブジェクト」を取得する。
4.  その「デバイスオブジェクト」のプロパティ（USB接続情報、Wi-Fi接続情報）に、今回の `[接続ハンドルID]` を追加・更新する。

### 接続方式の判別（Type Inference）

登録しようとしている `[接続ハンドルID]` が USB なのか Wi-Fi なのかは、ID の文字列パターンで判別します。

  * **Wi-Fi (TCP/IP) と判定する条件:**
      * 文字列に `.`（ドット）と `:`（コロン）が含まれる（例: `192.168.1.5:5555`）
      * または、文字列に `_tcp` や `adb-tls` が含まれる（例: `adb-Serial-..._tcp`）
  * **USB と判定する条件:**
      * 上記以外（通常は英数字のみの文字列）
      * または、取得した `ro.serialno` と `[接続ハンドルID]` が完全に一致する場合

-----

## 3. 実行フェーズ（scrcpyの起動）

ユーザーが GUI 上で接続ボタンを押した際、統合されたデータをもとにコマンドを構築します。

### ケース A: ユーザーが「USBで接続」を選択した場合

そのデバイスオブジェクトに紐づいている「USB判定された接続ハンドルID」を使用します。

  * **実行コマンド例:**
    ```text
    scrcpy -s PR6DB6C6YTLFA6T8
    ```

### ケース B: ユーザーが「Wi-Fiで接続」を選択した場合

そのデバイスオブジェクトに紐づいている「Wi-Fi判定された接続ハンドルID」を使用します。

  * **実行コマンド例:**
    ```text
    scrcpy -s 192.168.1.5:5555
    ```
    または（TLS接続の場合）
    ```text
    scrcpy -s adb-PR6DB6C6YTLFA6T8-DKvY8o._adb-tls-connect._tcp
    ```

### ケース C: 初期設定（TCP/IPモードへの切り替え）

まだ Wi-Fi 接続されていない（USBのみの状態）で、TCP モードを有効化する場合、必ず「USBのハンドル」を指定してポートを開放します。

  * **実行コマンド例:**
    ```text
    adb -s PR6DB6C6YTLFA6T8 tcpip 5555
    ```

-----

## 4. エッジケースへの対応ガイド

実装時に考慮すべき例外処理です。

1.  **Duplicate Serial (レアケース):**
    エミュレータなどを複数起動すると、すべて `emulator-5554` のように見えることがありますが、これらはID自体が異なるため通常通り処理して問題ありません。
2.  **`getprop` のタイムアウト:**
    Wi-Fi 接続が不安定なデバイスに対して `shell getprop` を投げると、応答が返ってこずアプリがフリーズする可能性があります。コマンド実行には必ず短いタイムアウト（例: 2〜3秒）を設定し、タイムアウトした場合はその接続を「応答なし」としてリストから除外するか、グレーアウト表示にしてください。
3.  **Unauthorized 状態:**
    `adb devices` で `unauthorized` となっているデバイスに対して `shell getprop` を送るとエラーになります。リスト取得の段階でステータスを確認し、許可されていないデバイスにはコマンドを送らないよう制御してください。

### まとめ：GUI表示のイメージ

このロジックを実装することで、GUI のリストは以下のように整理されます。

  * **Pixel 10 (PR6DB6C6...)**
      * 状態: オンライン
      * [ボタン] USBで操作 (ID: `PR6DB6C6...`)
      * [ボタン] Wi-Fiで操作 (ID: `adb-PR6DB6..._tcp`)
  * **Galaxy S23 (R5CT...)**
      * 状態: オンライン
      * [ボタン] USBで操作 (ID: `R5CT...`)
      * [無効] Wi-Fi未接続
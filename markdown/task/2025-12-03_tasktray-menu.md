# タスクトレイメニュー実装ガイド (UX強化フェーズ)

## 1. 概要

本実装の目的は、ウィンドウを開くことなく、タスクトレイアイコンの右クリックメニュー（コンテキストメニュー）から、日常的な操作を完結できるようにすることです。
特に、接続中のデバイスに対する「ミラーリングの開始/停止」を最速で行えるようにし、マルチデバイス運用時の利便性を向上させます。

## 2. アーキテクチャ設計

現在の `App.xaml.cs` にあるタスクトレイ関連のロジックを分離し、専任のクラスを作成することを推奨します。

### 2.1. 新規クラス: `TrayMenuManager`

* **責務:**
    * `NotifyIcon` (WinForms) の生成とライフサイクル管理。
    * コンテキストメニュー (`ContextMenuStrip`) の構築。
    * `DeviceManager` や `SettingsManager` のイベント購読とメニューの動的更新。
    * ユーザー操作（クリック）のハンドリングと、各マネージャークラスへのコマンド発行。
* **依存関係:**
    * `DeviceManager`: デバイスリストの取得、状態変更の検知、ミラーリング指示に使用。
    * `SettingsManager`: 設定の読み書き（自動接続フラグなど）に使用。
    * `ScrcpyProcessManager` (または `DeviceManager` 経由): プロセスの停止指示に使用。

## 3. メニュー構造の定義

コンテキストメニューは以下の4つのセクション（グループ）で構成し、セパレーター（区切り線）で視覚的に分割します。

1.  **【動的】デバイスリストセクション**
    * 現在登録されているデバイスのリスト。
    * クリックでミラーリングの ON/OFF を切り替え。
2.  **【静的】グローバル操作セクション**
    * 「すべてのミラーリングを終了」
3.  **【静的】設定・ユーティリティセクション**
    * 「自動接続を有効にする」（チェックボックス付き）
    * 「保存先フォルダを開く」
4.  **【静的】アプリ操作セクション**
    * 「設定画面を表示...」
    * 「終了」

## 4. 実装ロジック詳細

### 4.1. デバイスリストの動的生成

このセクションは、デバイスの接続状況や設定変更に応じてリアルタイムに変化する必要があります。

* **トリガー:**
    * `DeviceManager` からの「デバイスリスト変更通知（追加/削除/更新）」を購読します。
    * または、ミラーリング状態の変化（開始/停止）イベントも購読し、アイコンやテキストの状態を更新します。
* **生成ロジック:**
    1.  メニューが開かれる直前（`Opening` イベント）、または変更通知を受け取ったタイミングで、デバイスリストセクションの既存項目をクリアします。
    2.  `DeviceManager` から現在のデバイスリストを取得し、優先順位順（リスト順）にループ処理を行います。
    3.  各デバイスに対応するメニュー項目を作成します。
        * **表示名:** デバイス名（エイリアス）に加え、接続タイプ（USB/Wi-Fi）を付記すると親切です。
        * **状態表示:** 現在ミラーリング中であれば「チェックマーク」を付けるか、アイコンを変更して視覚的に区別します。
        * **アクション:** クリックイベントに「そのデバイスのミラーリング状態を反転（トグル）させる」処理を割り当てます。

### 4.2. 全停止機能 (Panic Button)

* **動作:**
    * クリックされたら、`ScrcpyProcessManager` (または `DeviceManager`) の「全プロセス停止メソッド」を呼び出します。
    * 実行中の `scrcpy` プロセスがない場合は、この項目をグレーアウト（無効化）する制御を入れると、より洗練されたUIになります。

### 4.3. 自動接続トグル (Global Auto Connect)

* **動作:**
    * メニュー項目自体を `CheckOnClick = true` (クリックでチェック状態を反転) の挙動にするのではなく、クリックイベント内で制御します。
    * クリック時:
        1.  現在の `Settings.GlobalAutoConnect` の値を反転させます。
        2.  `SettingsManager` を通じて設定をファイルに保存します。
        3.  メニュー項目のチェック状態を新しい値に更新します。
    * 初期化時:
        1.  アプリ起動時に設定ファイルから値を読み込み、チェック状態を反映させます。

### 4.4. 保存先フォルダを開く

* **動作:**
    * `SettingsManager` から現在の録画保存先パスを取得します。
    * Windowsのエクスプローラーを起動し、そのパスを開きます。
    * **エラーハンドリング:** フォルダが存在しない場合は、作成してから開くか、あるいはエラー通知を出すなどの配慮が必要です。

## 5. 連携フローの整理

1.  **初期化:**
    * アプリ起動 (`App.xaml.cs`) 時に `TrayMenuManager` をインスタンス化。
    * 静的なメニュー項目（終了など）を構築。
    * 各種イベントリスナーを登録。

2.  **イベント受信時の挙動:**
    * **デバイス接続時:** `DeviceManager` が検知 -> イベント発火 -> `TrayMenuManager` がメニュー再構築 -> リストに新デバイスが登場。
    * **ユーザーがメニュー操作:** `TrayMenuManager` がクリック検知 -> `DeviceManager` メソッド実行 -> `scrcpy` 起動/停止。

3.  **終了処理:**
    * アプリ終了時に `NotifyIcon` を確実に `Dispose` し、タスクトレイからアイコンが消えるようにします（プロセスが残る「ゴーストアイコン」現象の防止）。

## 6. 開発のポイント

* **スレッドセーフ:**
    * `DeviceManager` からのイベントはバックグラウンドスレッドで発生する可能性があります。UIコンポーネント（WinFormsのメニュー）を操作する際は、適切なスレッドコンテキスト（UIスレッド）へのマーシャリングが必要になる点に注意してください。
* **アイコンの視認性:**
    * デバイスの状態（接続中/切断中/ミラーリング中）を一目でわかるように、メニュー項目のアイコンやテキスト色を工夫すると、UXが大きく向上します。
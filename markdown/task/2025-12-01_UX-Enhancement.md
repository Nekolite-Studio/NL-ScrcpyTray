# 🚀 UX強化タスク (2025-12-01)

## 1. 概要

本フェーズでは、「**デバイス管理機能の強化**」に焦点を当てる。
単なる設定変更だけでなく、複数デバイス運用時の「**優先順位付け**」と、ケーブルの抜き差しを意識させない「**有線・無線のシームレスな連携（スマート・ハンドオーバー）**」を実装し、UXを劇的に向上させる。

---

## 2. 実装タスク詳細

### Task 1: 設定ウィンドウ (Settings Form) の実装

Reactモックアップのデザイン思想を取り入れ、**Windows Forms**で直感的かつ高機能な設定画面を実装する。

* **UI構成 (TabControl):**
    1.  **一般 (General):**
        * 自動接続 (AutoConnect) [ON/OFF]
        * 無線への自動切り替え (AutoSwitchToWifi) [ON/OFF]
        * 有線への自動切り替え (AutoSwitchToUsb) [ON/OFF]
        * 設定の個別管理 (SeparateSettings) [ON/OFF]
    2.  **映像 (Video):**
        * ビットレート (Mbps): プリセット選択 + 手動入力
        * 最大FPS: 30/60/90/120/**無制限**
        * 解像度: オリジナル/FHD/HD
        * コーデック: H.264/H.265/AV1
        * バッファ (ms): 低遅延/推奨/安定
    3.  **音声 (Audio):**
        * 音声転送 [ON/OFF]
        * ビットレート: 128/256kbps
        * コーデック: Opus/AAC/RAW
    4.  **録画 (Recording):**
        * 映像録画 [ON/OFF]
        * 音声録音 [ON/OFF]
        * 保存先フォルダ選択
    5.  **情報 (Info):**
        * デバイス情報表示 (**モデル名**, **シリアル**, **IP**, **ステータス**)
        * デバイス削除ボタン (Danger Zone)
* **UX要件:**
    * **Reactivity:** 設定変更時、`Apply` ボタン押下で即座に `scrcpy` プロセスを**再起動**して反映させる。
    * **Dark Mode:** OSの設定に合わせて配色を変更可能な設計にしておく。

---

### Task 2: デバイス優先順位ロジック (Device Prioritization)

複数台接続時に、ユーザーの意図通りにデバイスを選択するロジックを実装する。

* **UI (Main Window / List):**
    * `ListView` (またはカスタムコントロール) を使用し、登録済みデバイスをリスト表示。
    * **Drag & Drop:** アイテムをドラッグして優先順位（上下）を並べ替え可能にする。
    * **ステータス表示:** **USB**/**Wi-Fi**/**Offline** の状態をアイコンと色で可視化。
    * **アクション:** 接続/切断トグル、設定ボタン、削除ボタン。
* **データ構造:**
    * `settings.json` に `List<DeviceSetting> Devices` を追加。
    * リストの**インデックス順**をそのまま優先順位として扱う。
* **接続ロジック:**
    1.  USB接続イベント検知。
    2.  `adb devices -l` で現在利用可能な全デバイスを取得。
    3.  設定ファイルの `Devices` リストの**上から順にマッチング**を行う。
    4.  最も優先順位が高いデバイスに対して `scrcpy` を起動する。
    5.  新規デバイスの場合はリスト末尾に自動追加し、通知を表示する。

---

### Task 3: 有線・無線の紐づけ (Smart Handover)

「ケーブルを抜いたら無線で再接続」を実現するバックグラウンドロジック。

* **IPキャッシュ機構:**
    * **ポーリング:** アプリ起動中、USB接続されているデバイスに対して定期的に（例: 接続直後および定期的）以下の処理を行う。
        * `adb shell ip -o a` (または `ip route`) を実行し、**WLANインターフェースのIPアドレス**を取得。
        * `adb tcpip 5555` を実行し、**待受ポートを開放**しておく。
    * **メモリ保持:** `Device` オブジェクト内の `IpAddress` プロパティを更新し続ける。
* **ハンドオーバーロジック:**
    1.  **切断検知:** **USB切断イベント (WMI)** を受信。
    2.  **照合:** 切断されたデバイスのシリアルIDに対応する `Device` 設定を取得。
    3.  **再接続 (AutoSwitchToWifi有効時):**
        * `IpAddress` が有効であれば、即座に `adb connect <IP>:5555` を実行。
        * 成功すれば、接続モードを `Wireless` に切り替えて `scrcpy` を（無線プロファイルで）**再起動**。
        * 失敗時は通知を出して終了。

---

### Task 4: コードのリファクタリング (Architecture Update)

機能増加に伴い `Program.cs` の肥大化を防ぐため、責務を分割する。

* **クラス分割案:**
    * `DeviceManager`: デバイスリストの管理、優先順位ロジック、IPキャッシュを担当。
    * `AdbHelper`: ADBコマンド実行の実装詳細を隠蔽。
    * `ScrcpyController`: プロセスの起動・停止・再起動のみに集中。
    * `SettingsForm`: UIイベントのハンドリング。

---

## 3. 開発ステップ

1.  **[Step 1] Core Logic: `DeviceManager` クラスの実装**
    * 優先順位リスト管理 (`List<Device>`) とIPアドレス取得ロジックを作成。
2.  **[Step 2] UI: 設定ウィンドウの実装**
    * WinFormsでタブ付き設定画面を作成し、`Device` オブジェクトとバインディング。
3.  **[Step 3] UI: デバイスリスト (Main/Menu) の実装**
    * タスクトレイメニュー、またはメインウィンドウ（将来実装）でのリスト表示とDrag & Drop対応。
4.  **[Step 4] Logic Integration: ハンドオーバー機能の結合**
    * USB切断イベントに `DeviceManager.TrySwitchToWireless()` をフック。

---

## 4. 完了条件

* [ ] 設定画面でデバイスの順番を入れ替え、次回USB接続時にその順序が優先されること。
* [ ] USB接続中にIPアドレスが自動取得されていること。
* [ ] USBケーブルを抜いた際、数秒以内に無線接続でミラーリングが再開されること。
* [ ] 有線/無線それぞれで異なるビットレート設定が適用されること（個別設定有効時）。

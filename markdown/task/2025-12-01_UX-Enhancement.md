# UX Enhancement Task (2025-12-01)

## 1. 概要
本フェーズでは、コンテキストメニューのみの操作から脱却し、専用GUIを用いた直感的な設定変更と、マルチデバイス・ワイヤレス接続への対応を行う。
特に「設定変更のスムーズな適用（アプリ自体の再起動不要）」を重視し、ユーザー体験を向上させる。

## 2. 実装タスク詳細

### Task 1: 設定ウィンドウ (Settings Form) の実装
Windows Forms (`System.Windows.Forms.Form`) を使用した専用設定画面を作成する。

- **UI構成案:**
    - **ウィンドウ形式:** 固定サイズのダイアログ（モーダル表示推奨）。
    - **タブ構成:**
        1. **一般 (General):**
            - 自動起動 (AutoStartOnConnect) [ON/OFF]
            - 画面共有 (EnableVideo) [ON/OFF]
            - 音声共有 (EnableAudio) [ON/OFF]
            - 起動時に画面OFF (TurnScreenOffOnStart) [ON/OFF]
        2. **画質 (Quality):**
            - プリセット選択 (BufferMode): "Low Latency", "High Quality", "Custom"
            - (Custom選択時のみ有効化)
                - ビットレート (Mbps)
                - バッファサイズ (ms)
                - 最大解像度
        3. **デバイス (Device):**
            - 優先デバイス選択（マルチデバイス対応用）
            - ワイヤレス接続設定
    - **フッター:**
        - [保存して適用 (Save & Apply)] ボタン
        - [キャンセル] ボタン

- **挙動仕様 (UX要件):**
    - **即時適用ロジック:**
        - 「保存して適用」押下時、`settings.json` を更新する。
        - **もし `scrcpy` が実行中であれば、自動的にプロセスを停止し、新設定で即座に再起動する。**
        - これにより、ユーザーはアプリ（NL-ScrcpyTray）自体を再起動することなく、画質変更などを反映できる。

### Task 2: ADBパス解決の厳密化
内蔵 `scrcpy` フォルダ内の `adb.exe` を確実に使用するようにロジックを統一する。

- **実装方針:**
    - 現在の `ScrcpyPath` (`scrcpy/scrcpy.exe`) からディレクトリパスを取得し、同階層にある `adb.exe` を参照するヘルパーメソッドを作成する。
    - システム環境変数の `adb` ではなく、必ず同梱の `adb` を呼ぶことでバージョンの不整合を防ぐ。

### Task 3: マルチデバイス対応 (Multi-Device Support)
複数のAndroid端末が接続された場合のハンドリングを実装する。

- **実装方針:**
    1. **デバイスリスト取得:**
        - `adb devices -l` を定期実行（またはUSBイベント検知時）し、接続済みデバイスの `Serial` と `Model` を取得する。
    2. **ターゲット選択:**
        - 設定画面の「デバイス」タブ、またはタスクトレイの「対象デバイス」メニューで、操作対象のシリアルIDを選択可能にする。
    3. **起動コマンド修正:**
        - 選択されたシリアルIDがある場合、`scrcpy` 起動引数に `-s <Serial>` を付与する。
        - 未選択（null）の場合は、デフォルト（1台のみ接続時はそれを使用、複数台時はエラー通知）とする。

### Task 4: ワイヤレス接続 (Wireless / TCP/IP)
USBケーブルを抜いても操作を継続できる機能を追加する。

- **実装フロー:**
    1. **有効化:**
        - 設定画面またはトレイメニューに「ワイヤレス待受を有効化」ボタンを追加。
        - 押下時、対象デバイス（USB接続中）に対して `adb tcpip 5555` を実行。
    2. **接続:**
        - ユーザーがケーブルを抜いた（USB切断イベント検知）際、対象デバイスのIPアドレス（`adb shell ip route` 等で取得済みであること）に対して `adb connect <IP>:5555` を試行するロジックを検討。
        - *フェーズ1簡易実装案:* 手動で「ワイヤレス接続」ボタンを押し、IPアドレスを入力（または以前のIPを使用）して接続する。

## 3. 開発手順 (Step-by-Step)

1. **[Step 1] `AdbHelper` クラスの実装**
    - `adb.exe` のパス解決。
    - `GetConnectedDevices()` メソッドの実装（`adb devices -l` のパース）。
2. **[Step 2] `SettingsForm` GUIの実装**
    - デザイナーまたはコードベースでFormを作成。
    - `AppConfig` とのデータバインディング。
3. **[Step 3] 設定適用ロジックの実装**
    - `Main` ループまたは `Program` クラス内に `ReloadAndRestartScrcpy()` メソッドを追加。
4. **[Step 4] マルチデバイス・ワイヤレス機能の統合**
    - UIにデバイス選択を追加し、起動引数生成ロジックを更新。

## 4. 完了条件
- [ ] 設定画面から画質設定を変更し、「保存」を押すと画質が変わった状態でミラーリングが再開されること。
- [ ] 2台の端末を接続し、指定した方の端末が表示されること。
- [ ] `NL-ScrcpyTray` フォルダを移動させても、内蔵 `adb` を認識して動作すること。